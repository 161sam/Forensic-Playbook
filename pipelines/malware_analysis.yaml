# Malware Analysis Pipeline
# Focused malware detection and analysis workflow

name: "Malware Analysis Pipeline"
description: "Comprehensive malware detection and analysis"
version: "1.0.0"

config:
  continue_on_error: true
  parallel_execution: false

variables:
  target_path: "/mnt/evidence"
  memory_dump: "memory.dmp"
  disk_image: "disk.img"
  ioc_file: "config/iocs/malware_iocs.json"
  yara_rules: "config/yara/malware.yar"

modules:
  # Phase 1: Quick Triage
  - name: quick_triage
    description: "Initial system assessment"
    params:
      target: "${target_path}"
    priority: high

  # Phase 2: IoC Scanning
  - name: ioc_scan
    description: "Scan for malware IoCs"
    params:
      path: "${target_path}"
      ioc_file: "${ioc_file}"
      timeline: true
      scan_npm: true
      extract_strings: true
      hash_files: true
      format: json
    priority: critical

  # Phase 3: Memory Analysis (Malware Focus)
  - name: memory_analysis
    description: "Memory-based malware detection"
    params:
      dump: "${memory_dump}"
      processes: true
      network: true
      registry: false
      malware: true
      strings: true
    priority: critical
    condition: file_exists("${memory_dump}")

  # Phase 4: Filesystem Analysis (Suspicious Files)
  - name: filesystem_analysis
    description: "Locate suspicious files"
    params:
      image: "${disk_image}"
      include_deleted: true
      compute_hashes: true
      extract_strings: true
    priority: high

  # Phase 5: Persistence Mechanism Detection
  - name: quick_triage
    description: "Detect persistence mechanisms"
    params:
      target: "${target_path}"
    priority: high

  # Phase 6: Network Indicators
  - name: memory_analysis
    description: "Extract network connections"
    params:
      dump: "${memory_dump}"
      processes: false
      network: true
      registry: false
      malware: false
    priority: medium
    condition: file_exists("${memory_dump}")

# Malware-specific post-processing
post_analysis:
  - generate_report:
      format: html
      sections:
        - executive_summary
        - malware_indicators
        - ioc_matches
        - suspicious_processes
        - network_connections
        - persistence_mechanisms
        - timeline
      
      severity_filter: high  # Only high/critical findings
  
  - generate_ioc_feed:
      format: stix
      include_hashes: true
      include_domains: true
      include_ips: true
  
  - export_suspicious_files:
      destination: "suspicious_files/"
      max_size_mb: 100

notifications:
  on_malware_detected:
    - type: log
      level: critical
      message: "Malware detected: ${malware_type}"
  
  on_complete:
    - type: log
      message: "Malware analysis complete. Findings: ${total_indicators}"

outputs:
  malware_dir: "malware_analysis"
  ioc_dir: "ioc_feeds"
  suspicious_files_dir: "suspicious_files"
